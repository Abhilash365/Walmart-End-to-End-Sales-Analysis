

-- Create the database
CREATE DATABASE walmart;

-- Drop the table if it already exists to avoid conflicts
DROP TABLE IF EXISTS sales;

-- Create the sales table schema
CREATE TABLE IF NOT EXISTS sales (
    invoice_id VARCHAR(30) NOT NULL PRIMARY KEY,
    branch VARCHAR(5) NOT NULL,
    city VARCHAR(30) NOT NULL,
    customer_type VARCHAR(30) NOT NULL,
    gender VARCHAR(30) NOT NULL,
    product_line VARCHAR(100) NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    quantity INT NOT NULL,
    tax_pct NUMERIC(6,4) NOT NULL,
    total DECIMAL(12, 4) NOT NULL,
    date TIMESTAMP NOT NULL, -- Using TIMESTAMP as in user's request
    time TIME NOT NULL,
    payment VARCHAR(15) NOT NULL,
    cogs DECIMAL(10,2) NOT NULL,
    gross_margin_pct NUMERIC(11,9),
    gross_income DECIMAL(12, 4),
    rating NUMERIC(3, 1)
);


-- == SECTION 2: DATA LOADING (PostgreSQL Specific)


-- This COPY command is for PostgreSQL.
-- You must update the file path 'D:\analyst\WalmartSalesData.csv'
-- to the actual location of your CSV file on your server.
-- MySQL users would use the 'LOAD DATA INFILE' command instead.

COPY sales (Invoice_ID, Branch, City, Customer_type, Gender, Product_line, Unit_price, Quantity, tax_pct, Total, date, time, Payment, cogs, gross_margin_pct, gross_income, rating)
FROM 'D:\analyst\WalmartSalesData.csv'
WITH (FORMAT CSV, HEADER);

-- After loading, check the data
SELECT * FROM sales LIMIT 10;


-- == SECTION 3: DATA CLEANING & FEATURE ENGINEERING


-- 1. Add time_of_day column
ALTER TABLE sales ADD COLUMN time_of_day VARCHAR(20);

UPDATE sales
SET time_of_day = (
    CASE
        WHEN time BETWEEN '00:00:00' AND '12:00:00' THEN 'Morning'
        WHEN time BETWEEN '12:01:00' AND '16:00:00' THEN 'Afternoon'
        ELSE 'Evening'
    END
);

-- 2. Add day_name column
ALTER TABLE sales ADD COLUMN day_name VARCHAR(10);

-- Using PostgreSQL's TO_CHAR to extract the day name.
-- (MySQL would use DAYNAME(date))
UPDATE sales
SET day_name = TO_CHAR(date, 'Day');

-- 3. Add month_name column
ALTER TABLE sales ADD COLUMN month_name VARCHAR(10);

-- Using PostgreSQL's TO_CHAR to extract the month name.
-- (MySQL would use MONTHNAME(date))
UPDATE sales
SET month_name = TO_CHAR(date, 'Month');

-- Check the new columns
SELECT invoice_id, time_of_day, day_name, month_name
FROM sales
LIMIT 5;


-- == SECTION 4: STRATEGIC ANALYSIS QUERIES



-- == Category 1: Generic (Location & Operational Efficiency)


-- Question 1.1: Benchmarking Branch Performance
-- Which branch is the most efficient at generating profit?
SELECT
    branch,
    (SUM(gross_income) / SUM(total)) * 100 AS gross_profit_margin_pct
FROM sales
GROUP BY branch
ORDER BY gross_profit_margin_pct DESC;


-- Question 1.2: City vs. Branch Consistency
-- Does the highest-revenue city also have the highest average rating?
SELECT
    city,
    branch,
    SUM(total) AS total_revenue,
    AVG(rating) AS avg_rating
FROM sales
GROUP BY city, branch
ORDER BY total_revenue DESC;


-- Question 1.3: Sales Consistency (PostgreSQL Syntax)
-- Which branch has the most volatile (least predictable) daily sales?
-- (Note: MySQL would use STDDEV() instead of STDDEV_SAMP())
SELECT
    branch,
    STDDEV_SAMP(daily_total) / AVG(daily_total) AS coefficient_of_variation
FROM (
    SELECT
        branch,
        DATE(date) AS sale_date,
        SUM(total) AS daily_total
    FROM sales
    GROUP BY branch, sale_date
) AS daily_sales
GROUP BY branch
ORDER BY coefficient_of_variation DESC;



-- == Category 2: Product (Profitability & Demand)


-- Question 2.1: Product Line Profitability Deep Dive
-- Which Product Line provides the highest contribution to Gross Income?
SELECT
    product_line,
    SUM(gross_income) AS total_gross_income,
    SUM(total) AS total_revenue
FROM sales
GROUP BY product_line
ORDER BY total_gross_income DESC
LIMIT 3;


-- Question 2.2: Top Line by Basket Size
-- What is the average quantity per transaction for the top 3 revenue-generating product lines?
WITH TopProductLines AS (
    SELECT
        product_line,
        SUM(total) AS total_revenue
    FROM sales
    GROUP BY product_line
    ORDER BY total_revenue DESC
    LIMIT 3
)
SELECT
    s.product_line,
    AVG(s.quantity) AS avg_quantity_per_transaction
FROM sales s
JOIN TopProductLines tpl ON s.product_line = tpl.product_line
GROUP BY s.product_line
ORDER BY avg_quantity_per_transaction DESC;


-- Question 2.3: VAT Impact on Top-Selling Products
-- How do average VAT contributions differ between the top-selling (by quantity)
-- and top-profit (by gross income) product lines?
WITH ProductRanks AS (
    SELECT
        product_line,
        SUM(quantity) AS total_quantity,
        SUM(gross_income) AS total_profit
    FROM sales
    GROUP BY product_line
),
TopSelling AS (
    SELECT product_line FROM ProductRanks ORDER BY total_quantity DESC LIMIT 1
),
TopProfit AS (
    SELECT product_line FROM ProductRanks ORDER BY total_profit DESC LIMIT 1
)
SELECT
    'Top Selling (by Qty)' AS category,
    product_line,
    AVG(tax_pct) AS avg_vat_pct
FROM sales
WHERE product_line = (SELECT product_line FROM TopSelling)
GROUP BY product_line
UNION ALL
SELECT
    'Top Profitable (by Income)' AS category,
    product_line,
    AVG(tax_pct) AS avg_vat_pct
FROM sales
WHERE product_line = (SELECT product_line FROM TopProfit)
GROUP BY product_line;



-- == Category 3: Sales (Trend & Driver Analysis)


-- Question 3.1: Revenue vs. Profit Seasonality
-- Which month had the highest Total Revenue, and did it also yield the highest Gross Income?
SELECT
    month_name,
    SUM(total) AS total_revenue,
    SUM(gross_income) AS total_gross_income
FROM sales
GROUP BY month_name
ORDER BY total_revenue DESC;


-- Question 3.2: Transaction Value Segmentation
-- How does the Average Transaction Value (Total) compare between Morning, Afternoon, and Evening?
SELECT
    time_of_day,
    AVG(total) AS avg_transaction_value
FROM sales
GROUP BY time_of_day
ORDER BY avg_transaction_value DESC;


-- Question 3.3: Promotion Effectiveness (Implied)
-- How does the Gross Profit Margin compare between 'Member' and 'Normal' customers?
SELECT
    customer_type,
    (SUM(gross_income) / SUM(total)) * 100 AS gross_profit_margin_pct
FROM sales
GROUP BY customer_type;



-- == Category 4: Customer (Behavioral & Loyalty Drivers)


-- Question 4.1: Customer Value Comparison
-- Do 'Member' or 'Normal' customers generate a higher Average Total Revenue per Visit?
SELECT
    customer_type,
    AVG(total) AS avg_revenue_per_visit
FROM sales
GROUP BY customer_type
ORDER BY avg_revenue_per_visit DESC;


-- Question 4.2: Gender-Product Line Loyalty
-- For the most profitable product line, is there a significant gender preference?
WITH TopProfitProduct AS (
    SELECT product_line
    FROM sales
    GROUP BY product_line
    ORDER BY SUM(gross_income) DESC
    LIMIT 1
)
SELECT
    gender,
    COUNT(*) AS transaction_count,
    SUM(total) AS total_spend
FROM sales
WHERE product_line = (SELECT product_line FROM TopProfitProduct)
GROUP BY gender
ORDER BY transaction_count DESC;


-- Question 4.3: Rating Driver
-- Is there a correlation between the Average Customer Rating and the average
-- Quantity purchased in a single transaction?
SELECT
    rating,
    AVG(quantity) AS avg_quantity_per_rating
FROM sales
GROUP BY rating
ORDER BY rating;


-- Question 4.4: Rating Dip Analysis
-- For Branch B, which combination of day and time yields the lowest average rating?
SELECT
    day_name,
    time_of_day,
    AVG(rating) AS avg_rating
FROM sales
WHERE branch = 'B'
GROUP BY day_name, time_of_day
ORDER BY avg_rating ASC
LIMIT 1;
